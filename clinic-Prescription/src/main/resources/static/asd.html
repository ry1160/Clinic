<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <link rel="stylesheet" href="layui/css/layui.css"  media="all">
    <script src="layui/layui.js"></script>
</head>
<body>
<script type="text/html" id="toolbarDemo">
    <button type="button" class="layui-btn layui-btn-radius" lay-event="add" style="position: relative;left: -100px">+添加已选中药品</button>
</script>
<fieldset class="layui-elem-field layui-field-title">
    <legend>新开就诊</legend>
</fieldset>

<div align="center" style="padding: 50px;background-color: #f2f2f2">
<form class="layui-form layui-form-pane1" action="" lay-filter="first">
    <div style="height:290px;background-color: white;border-radius: 30px;box-shadow: 5px 5px 0px #3f3f3f;margin-left: -10px;padding-top: 30px">
    <div class="layui-inline" style="margin-top: 5px">
        <label class="layui-form-label">患者</label>
        <div class="layui-inline">
            <select name="categoryLevel99" lay-filter="categoryLevel99">

            </select>
        </div>
    </div>
    <div class="layui-inline">
        <label class="layui-form-label">患者卡号</label>
        <div class="layui-input-block">
            <input type="text" name="patientNo" autocomplete="off" class="layui-input" size="24">
        </div>
    </div>
    <div class="layui-inline">
        <label class="layui-form-label">患者年龄</label>
        <div class="layui-input-block">
            <input type="text" name="patientAge" autocomplete="off" class="layui-input" size="24">
        </div>
    </div>
    <div class="layui-inline">
        <label class="layui-form-label">出生日期</label>
        <div class="layui-input-block">
            <input type="text" name="dateOfBirth" autocomplete="off" class="layui-input" size="24">
        </div>
    </div>
    <div class="layui-inline" style="margin-top: 20px">
        <label class="layui-form-label">性别</label>
        <div class="layui-input-block">
            <input type="text" name="gender" autocomplete="off" class="layui-input" size="24">
        </div>
    </div>
    <div class="layui-inline" style="margin-top: 20px">
        <label class="layui-form-label">手机号码</label>
        <div class="layui-input-block">
            <input type="text" name="mobile" autocomplete="off" class="layui-input" size="24">
        </div>
    </div>
    <div class="layui-inline" style="margin-top: 20px">
        <label class="layui-form-label">身份证</label>
        <div class="layui-input-block">
            <input type="text" name="idCard" autocomplete="off" class="layui-input" size="24">
        </div>
    </div>
    <div class="layui-inline" style="margin-top: 20px">
        <label class="layui-form-label">接诊类型</label>
        <div class="layui-inline">
            <select name="flatformId" lay-filter="flatformId">
                <option value="">请选择</option>
                <option value="1">初诊</option>
                <option value="2">复诊</option>
            </select>
        </div>
    </div>
    <div class="layui-inline" style="margin-top: 20px;padding-left: -200px">
        <label class="layui-form-label">地址</label>
        <div class="layui-input-block">
            <input type="text" name="softwareName" autocomplete="off" class="layui-input" size="24">
        </div>
    </div>
    <div class="layui-inline" style="margin-top: 20px">
        <label class="layui-form-label">详细地址</label>
        <div class="layui-input-block">
            <input type="text" name="softwareName" autocomplete="off" class="layui-input" size="24">
        </div>
    </div>
    <div class="layui-form" style="margin-top: 20px">
        <div class="layui-fluid">
            <div class="layui-form layui-col-md12">
                <div class="layui-form-item">
                    <div class="layui-col-md4" style="padding-left: 22px">
                        <label class="layui-form-label">诊断</label>
                        <div class="layui-input-block">
                            <div style="width: 450px">
                                <select name="allDiagnosisType" lay-filter="allDiagnosisType" xm-select="allDiagnosisType">
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="layui-col-md4" style="padding-left: 225px">
                        <label class="layui-form-label">医嘱</label>
                        <div class="layui-input-block">
                            <div style="width: 450px">
                                <select name="allMedicalAdvice" id="allMedicalAdvice" lay-filter="allMedicalAdvice" xm-select="allMedicalAdvice">
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-row ">
                    <div class="test-table-reload-btn" style="margin-bottom: 10px;">
                        <button type="button" class="layui-btn layui-btn-danger" lay-submit lay-filter="btn_submit" id="btn_submit"><i class="layui-icon">&#xe681</i>保存</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div align="center" style="height:450px;background-color: white;border-radius: 30px;box-shadow: 5px 5px 0px #3f3f3f;margin-left: -10px;padding-top: 30px;margin-top: 30px">
<div style="display: inline-block;width: 600px;height:350px;border: 1px solid;position: relative;left: 20px;top:-80px;">
    <div class="layui-inline" style="position: absolute;left: 20px" id="prescriptionType">
        <div class="layui-inline" style="width: 110px">
            <select name="prescriptionType" lay-filter="prescriptionType">

            </select>
        </div>
        <div class="layui-inline" style="margin-left: 10px;">
            <button type="button" class="layui-btn layui-btn-radius" style="width: 103px">西/成药处方</button>
        </div>
    </div>
    <div class="layui-form">
        <table class="layui-table">
            <colgroup>
                <col width="150">
                <col width="150">
                <col width="200">
                <col>
            </colgroup>
            <thead>
            <tr>
                <th>人物</th>
                <th>民族</th>
                <th>出场时间</th>
                <th>格言</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>贤心</td>
                <td>汉族</td>
                <td>1989-10-14</td>
                <td>人生似修行</td>
            </tr>
            <tr>
                <td>张爱玲</td>
                <td>汉族</td>
                <td>1920-09-30</td>
                <td>于千万人之中遇见你所遇见的人，于千万年之中，时间的无涯的荒野里…</td>
            </tr>
            <tr>
                <td>Helen Keller</td>
                <td>拉丁美裔</td>
                <td>1880-06-27</td>
                <td> Life is either a daring adventure or nothing.</td>
            </tr>
            <tr>
                <td>岳飞</td>
                <td>汉族</td>
                <td>1103-北宋崇宁二年</td>
                <td>教科书再滥改，也抹不去“民族英雄”的事实</td>
            </tr>
            <tr>
                <td>孟子</td>
                <td>华夏族（汉族）</td>
                <td>公元前-372年</td>
                <td>猿强，则国强。国强，则猿更强！ </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>
<div style="display: inline-block;width: 600px;padding: 0px">
    <div class="layui-inline" style="margin-right: -40px;margin-left: -30px;">
        <label class="layui-form-label">药品分类</label>
        <div class="layui-inline">
            <select name="medicineType" lay-filter="medicineType">

            </select>
        </div>
    </div>
    <div class="layui-inline">
        <label class="layui-form-label">名称</label>
        <div class="layui-input-block">
            <input type="text" name="nameOrPinYin" autocomplete="off" class="layui-input" size="20" placeholder="输入药品名称/拼音">
        </div>
    </div>
    <table id="medicine" lay-filter="medicine"></table>
</div>
</div>
</form>
</div>
<link href="layui2/formSelects-v4.css" rel="stylesheet" />
<script src="layui2/formSelects-v4.js"></script>
<script>
    layui.use(['table','form'], function() {
        var table = layui.table;
        var form = layui.form;
        var $ = layui.$;
        var myTable = initTable();
        var prescriptionTypeId = 1;
        var str = [];

        function medicineType(prescriptionTypeId) {
            var html = "<option value=''>--请选择--</option>";
            $.ajax({
                url: "http://localhost:8081/api/getAllMedicineType?prescriptionTypeId="+prescriptionTypeId,
                type: "get",
                dataType: "json",
                xhrFields: {
                    withCredentials: true
                },
                success: function (data) {
                    for (var i = 0; i < data.responseBody.length; i++) {
                        html += "<option value=" + data.responseBody[i].id + ">" + data.responseBody[i].medicineTypeName + "</option>";
                    }
                    $("[name=medicineType]").append(html);
                    getPrescriptionType();
                    form.render();
                },
                error:function(data){
                    alert(data.status);
                }
            });
        }

        function initTable(){
            return table.render({
                elem: '#medicine'
                , height: 390
                ,width:515
                , title: '西药信息'
                , url: "http://localhost:8081/api/getMedicine?prescriptionTypeId=1"
                , toolbar: '#toolbarDemo'
                ,page:true
                ,defaultToolbar: []
                , limit: 3
                , limits:[1,2,3,4,5,6]
                ,totalRow: true //开启合计行
                , cols: [[
                    {type: 'checkbox',fixed:'left'},
                    {field: 'medicineName',align:'left',title: '药品名称',width:160},
                    {field: 'medicineSpecifications',align:'left', title: '规格',width:100},
                    {field: 'stock', title: '库存',align:'left',width:100},
                    {field: 'retailPrice', title: '价格',align:'left',width:100}
                ]]
            });
        }
        form.on('select(prescriptionType)',function (data) {
            var name = data.value!=3?str[data.value-1]+"处方":str[data.value-1];
            $("#prescriptionType").append("<div class=\"layui-inline\" style=\"margin-left: 10px\">\n" +
                "            <button type=\"button\" class=\"layui-btn layui-btn-radius\" style=\"width: 103px\">"+name+"</button></div>")
        })
        form.on('select(medicineType)', function(data){
            search(data.value,$("[name=nameOrPinYin]").val());
        })
        $("[name=nameOrPinYin]").blur(function () {
            search($("[name=medicineType]").val(),$(this).val());
        });
        function search(medicineTypeValue,nameOrPinYin){
                myTable.reload({
                    page:{curr:1},
                    method:'get',
                    where:{
                        prescriptionTypeId:prescriptionTypeId,
                        medicineTypeId:medicineTypeValue,
                        nameOrPinYin:nameOrPinYin
                    }
                });
                return false;
        }
        getAllPatient();
        function getAllPatient(){
            var html = "<option value=''>--请选择--</option>";
            $.ajax({
                url: "http://localhost:8081/api/getAllPatient",
                type: "get",
                dataType: "json",
                xhrFields: {
                    withCredentials: true
                },
                success: function (data) {
                    for (var i = 0; i < data.responseBody.length; i++) {
                        html += "<option value=" + data.responseBody[i].id + ">" + data.responseBody[i].patientName + "</option>";
                    }
                    $("[name=categoryLevel99]").append(html);
                    form.render();
                    getAllDiagnosisType();
                },
                error:function(data){
                    alert(data.status);
                }
            });
        }
        function getPrescriptionType(){
            var html = "<option value='0'>--添加处方--</option>";
            $.ajax({
                url: "http://localhost:8081/api/getPrescriptionType",
                type: "get",
                dataType: "json",
                xhrFields: {
                    withCredentials: true
                },
                success: function (data) {
                    for (var i = 0; i < data.responseBody.length; i++) {
                        html += "<option value=" + data.responseBody[i].id + ">" + data.responseBody[i].prescriptionTypeName + "</option>";
                        str[i] = data.responseBody[i].prescriptionTypeName;
                    }
                    $("[name=prescriptionType]").append(html);
                    form.render();
                },
                error:function(data){
                    alert(data.status);
                }
            });
        }

        form.on('select(categoryLevel99)', function(data){
            $.ajax({
                url: "http://localhost:8081/api/getPatientById?id="+data.value,
                type: "get",
                dataType: "json",
                success: function (data) {
                    var gender = data.responseBody.gender==1?'女':'男';
                    form.val('first', {
                        "patientNo": data.responseBody.patientNo
                        ,"patientAge": data.responseBody.patientAge
                        ,"dateOfBirth": data.responseBody.dateOfBirth
                        ,"gender": gender
                        ,"mobile": data.responseBody.mobile
                        ,"idCard": data.responseBody.idCard
                    });
                    form.render();
                }
            });
        });

        function getAllDiagnosisType(){
            $.ajax({
                url: "http://localhost:8081/api/getAllDiagnosisType",
                type: "get",
                dataType: "json",
                success: function (data) {
                    var arr1 = [];
                    for (var i = 0;i<data.responseBody.allDiagnosisType.length;i++){
                        arr1[i]={"name":data.responseBody.allDiagnosisType[i].diagnosisTypeName,"value":data.responseBody.allDiagnosisType[i].id};
                    }
                    layui.formSelects.data('allDiagnosisType', 'local', {arr:arr1});
                    getAllMedicalAdvice();
                }
            });
        }

        function getAllMedicalAdvice(){
            $.ajax({
                url: "http://localhost:8081/api/getAllMedicalAdvice",
                type: "get",
                dataType: "json",
                success: function (data) {
                    var arr1 = [];
                    for (var i = 0;i<data.responseBody.length;i++){
                        arr1[i]={"name":data.responseBody[i].name,"value":data.responseBody[i].id};
                    }
                    layui.formSelects.data('allMedicalAdvice', 'local', {arr:arr1});
                    medicineType(1);
                }
            });
        }

        table.on('toolbar(medicine)', function(obj){
            alert("ss");
        });

        var form = layui.form, layer = parent.layer == undefined ? layui.layer : parent.layer;
        form.on('submit(btn_submit)', function (obj) {
            layer.confirm('确认录入无误吗？', {
                btn: ['确认', '再看看']
            }, function () {
                var getName = JSON.stringify(layui.formSelects.value('allDiagnosisType', 'valStr'));//取值name数组
                layer.msg("你选择的值为：" + getName, { offset: '150px', icon: 1, time: 5000 }, function () {
                });
            });
        });

    });
</script>

</body>
</html>